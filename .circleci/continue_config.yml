version: 2.1

orbs:
  terraform: circleci/terraform@3.7.0

parameters:
  run-vpc-changes:
    type: boolean
    default: false
  run-ec2-changes:
    type: boolean
    default: false

jobs:
  # VPC: validate & plan
  validate-plan-vpc:
    executor: terraform/default
    steps:
      - checkout
      - terraform/init:
          path: terraform/vpc
          backend_config: bucket=tfstate-bucket-vpc-202506,key=vpc/terraform.tfstate,region=ap-northeast-1
      - terraform/validate:
          path: terraform/vpc
      - terraform/plan:
          path: terraform/vpc
      - persist_to_workspace:
          root: .
          paths:
            - terraform/vpc/.terraform
            - terraform/vpc/.terraform.lock.hcl

  # VPC: apply
  apply-vpc:
    executor: terraform/default
    steps:
      - checkout
      - attach_workspace:
          at: .
      - terraform/apply:
          path: terraform/vpc

  # EC2: validate & plan
  validate-plan-ec2:
    executor: terraform/default
    steps:
      - checkout
      - run:
          name: Normalize SSH key
          command: |
            # 改行や余分な空白を削除
            NORMALIZED_KEY=$(echo "$EC2_PUBLIC_KEY" | tr -d '\n\r' | tr -s ' ')
            echo "export TF_VAR_ec2_public_key=\"${NORMALIZED_KEY}\"" >> $BASH_ENV
            echo "Original key length: ${#EC2_PUBLIC_KEY}"
            echo "Normalized key length: $(echo $NORMALIZED_KEY | wc -c)"
            echo "Key type: $(echo $NORMALIZED_KEY | awk '{print $1}')"
      - terraform/init:
          path: terraform/ec2
          backend_config: bucket=tfstate-bucket-vpc-202506,key=ec2/terraform.tfstate,region=ap-northeast-1
      - terraform/validate:
          path: terraform/ec2
      - terraform/plan:
          path: terraform/ec2
      - persist_to_workspace:
          root: .
          paths:
            - terraform/ec2/.terraform
            - terraform/ec2/.terraform.lock.hcl

  # EC2: apply
  apply-ec2:
    executor: terraform/default
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Normalize SSH key
          command: |
            # 改行や余分な空白を削除
            NORMALIZED_KEY=$(echo "$EC2_PUBLIC_KEY" | tr -d '\n\r' | tr -s ' ')
            echo "export TF_VAR_ec2_public_key=\"${NORMALIZED_KEY}\"" >> $BASH_ENV
            echo "Normalized key length: $(echo $NORMALIZED_KEY | wc -c)"
            echo "Key type: $(echo $NORMALIZED_KEY | awk '{print $1}')"
      - terraform/apply:
          path: terraform/ec2

workflows:
  # VPC: プルリクエスト時
  vpc-pr-check:
    when:
      and:
        - << pipeline.parameters.run-vpc-changes >>
        - not:
            equal: [ main, << pipeline.git.branch >> ]
    jobs:
      - validate-plan-vpc:
          context: terraform

  # VPC: main マージ時
  vpc-apply:
    when:
      and:
        - << pipeline.parameters.run-vpc-changes >>
        - equal: [ main, << pipeline.git.branch >> ]
    jobs:
      - validate-plan-vpc:
          context: terraform
      - apply-vpc:
          context: terraform
          requires:
            - validate-plan-vpc

  # EC2: プルリクエスト時
  ec2-pr-check:
    when:
      and:
        - << pipeline.parameters.run-ec2-changes >>
        - not:
            equal: [ main, << pipeline.git.branch >> ]
    jobs:
      - validate-plan-ec2:
          context: terraform

  # EC2: main マージ時
  ec2-apply:
    when:
      and:
        - << pipeline.parameters.run-ec2-changes >>
        - equal: [ main, << pipeline.git.branch >> ]
    jobs:
      - validate-plan-ec2:
          context: terraform
      - apply-ec2:
          context: terraform
          requires:
            - validate-plan-ec2